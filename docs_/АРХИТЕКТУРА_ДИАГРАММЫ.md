# Архитектура MVVM с ViewModelFirst - Визуальная схема

## Общая архитектура приложения

```
???????????????????????????????????????????????????????????????????????????
?                         ПРИЛОЖЕНИЕ (App.xaml.cs)                        ?
?                         Composition Root + DI                           ?
???????????????????????????????????????????????????????????????????????????
                                    ?
                    ?????????????????????????????????
                    ?                               ?
        ????????????????????????        ????????????????????????
        ?   VIEWMANAGER        ?        ?   DI CONTAINER       ?
        ?   (Управление UI)    ?        ?   (Ninject)          ?
        ????????????????????????        ????????????????????????
                    ?                               ?
                    ?                               ??? Repository
                    ?                               ??? Logic
                    ?                               ??? ViewModel
        ????????????????????????
        ?   VIEW (XAML)        ??????????????????
        ?   - MainWindow       ?                ?
        ?   - BaseView         ?                ?
        ????????????????????????                ?
                    ?                            ?
                    ? DataContext                ?
                    ?                            ?
        ????????????????????????                ?
        ?   VIEWMODEL          ??????????????????
        ?   - MainViewModel    ?
        ?   - Commands         ?
        ?   - Properties       ?
        ????????????????????????
                    ?
                    ? ILogic
                    ?
        ????????????????????????
        ?   MODEL              ?
        ?   - ProductLogic     ?
        ?   - BusinessLogic    ?
        ????????????????????????
                    ?
                    ? IRepository
                    ?
        ????????????????????????
        ?   DATA ACCESS LAYER  ?
        ?   - EntityFramework  ?
        ?   - Database         ?
        ????????????????????????
```

---

## ViewModelFirst: Последовательность запуска

```
??????????????????????????????????????????????????????????????????
?  ЭТАП 1: ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ (App.OnStartup)              ?
??????????????????????????????????????????????????????????????????
                              ?
                              ?
    ?????????????????????????????????????????????????????????????
    ?  ConfigureDependencyInjection()                           ?
    ?  ?????????????????????????????????????????????????????    ?
    ?  kernel.Bind<IRepository>().To<EntityRepository>()        ?
    ?  kernel.Bind<ILogic>().To<ProductLogic>()                 ?
    ?  kernel.Bind<MainViewModel>().ToSelf()                    ?
    ?????????????????????????????????????????????????????????????
                              ?
                              ?
??????????????????????????????????????????????????????????????????
?  ЭТАП 2: СОЗДАНИЕ VIEWMANAGER                                  ?
??????????????????????????????????????????????????????????????????
                              ?
                              ?
    ?????????????????????????????????????????????????????????????
    ?  var viewManager = new ViewManager();                     ?
    ?????????????????????????????????????????????????????????????
                              ?
                              ?
??????????????????????????????????????????????????????????????????
?  ЭТАП 3: СОЗДАНИЕ VIEWMODEL (ViewModelFirst!)                 ?
??????????????????????????????????????????????????????????????????
                              ?
                              ?
    ?????????????????????????????????????????????????????????????
    ?  var mainViewModel = kernel.Get<MainViewModel>();         ?
    ?                                                            ?
    ?  Ninject автоматически создает:                           ?
    ?  1. EntityRepository<Product>                             ?
    ?  2. BusinessFunctions                                     ?
    ?  3. ProductLogic(repository, functions)                   ?
    ?  4. MainViewModel(logic)                                  ?
    ?                                                            ?
    ?  ViewModel загружает начальные данные                     ?
    ?????????????????????????????????????????????????????????????
                              ?
                              ?
??????????????????????????????????????????????????????????????????
?  ЭТАП 4: СОЗДАНИЕ И ПОКАЗ VIEW                                 ?
??????????????????????????????????????????????????????????????????
                              ?
                              ?
    ?????????????????????????????????????????????????????????????
    ?  viewManager.ShowMainWindow(mainViewModel);               ?
    ?                                                            ?
    ?  ViewManager:                                             ?
    ?  1. var window = new MainWindow(viewModel);               ?
    ?  2. window.DataContext = viewModel; (автоматически)       ?
    ?  3. window.Show();                                        ?
    ?????????????????????????????????????????????????????????????
                              ?
                              ?
??????????????????????????????????????????????????????????????????
?  РЕЗУЛЬТАТ: ОКНО ОТОБРАЖАЕТСЯ ПОЛЬЗОВАТЕЛЮ                    ?
?  Все Binding работают автоматически                           ?
??????????????????????????????????????????????????????????????????
```

---

## Взаимодействие View ? ViewModel ? Model

```
????????????????????????????????????????????????????????????????????
?                         ПОЛЬЗОВАТЕЛЬ                             ?
?                    (Нажимает кнопку "Обновить")                  ?
????????????????????????????????????????????????????????????????????
                              ?
                              ?
????????????????????????????????????????????????????????????????????
?  VIEW (MainWindow.xaml)                                          ?
?  ??????????????????????????????????????????????????????????????  ?
?  <Button Command="{Binding RefreshCommand}" />                   ?
?                                                                   ?
?  XAML Binding автоматически вызывает команду в ViewModel         ?
????????????????????????????????????????????????????????????????????
                              ?
                              ?
????????????????????????????????????????????????????????????????????
?  VIEWMODEL (MainViewModel.cs)                                    ?
?  ??????????????????????????????????????????????????????????????  ?
?  RefreshCommand.Execute() вызывает:                              ?
?                                                                   ?
?  private void LoadProducts()                                     ?
?  {                                                               ?
?      var products = _logic.GetAllProducts(); ?????               ?
?      Products.Clear();                            ?               ?
?      foreach (var p in products)                  ?               ?
?          Products.Add(ToDto(p));                  ?               ?
?      OnPropertyChanged("Products"); ???????????????????           ?
?  }                                                ?   ?           ?
?????????????????????????????????????????????????????????????????????
                              ?                     ?   ?
                              ?                     ?   ?
????????????????????????????????????????????????????????????????????
?  MODEL (ProductLogic.cs)                         ?   ?           ?
?  ??????????????????????????????????????????????  ?   ?           ?
?  public List<Product> GetAllProducts()           ?   ?           ?
?  {                                               ?   ?           ?
?      return _repository.GetAll(); ????????????????   ?           ?
?  }                                                    ?           ?
?????????????????????????????????????????????????????????????????????
                              ?                         ?
                              ?                         ?
????????????????????????????????????????????????????????????????????
?  DATA ACCESS LAYER (EntityRepository.cs)             ?           ?
?  ??????????????????????????????????????????????????  ?           ?
?  public List<Product> GetAll()                       ?           ?
?  {                                                   ?           ?
?      using var context = new AppDbContext();         ?           ?
?      return context.Products.ToList();               ?           ?
?  }                                                   ?           ?
????????????????????????????????????????????????????????????????????
                              ?                         ?
                              ?                         ?
????????????????????????????????????????????????????????????????????
?  DATABASE (SQL Server / SQLite)                      ?           ?
?  ??????????????????????????????????????????????????  ?           ?
?  SELECT * FROM Products                              ?           ?
?                                                      ?           ?
?  Возвращает: List<Product>                           ?           ?
????????????????????????????????????????????????????????????????????
                              ?                         ?
                              ?                         ?
????????????????????????????????????????????????????????????????????
?  МАППИНГ (Product ? ProductDto)                      ?           ?
?  ??????????????????????????????????????????????????  ?           ?
?  private ProductDto ToDto(Product product)           ?           ?
?  {                                                   ?           ?
?      return new ProductDto                           ?           ?
?      {                                               ?           ?
?          Id = product.Id,                            ?           ?
?          Name = product.Name,                        ?           ?
?          // ... + INotifyPropertyChanged             ?           ?
?      };                                              ?           ?
?  }                                                   ?           ?
????????????????????????????????????????????????????????           ?
                              ?                                     ?
                              ?                                     ?
????????????????????????????????????????????????????????????????????
?  VIEWMODEL обновляет коллекцию                                   
?  ??????????????????????????????????????????????????????????????  
?  Products.Add(dto);                                              
?  OnPropertyChanged("Products"); ??????????????????????????????????
????????????????????????????????????????????????????????????????????
                              ?                                     ?
                              ?                                     ?
????????????????????????????????????????????????????????????????????
?  VIEW АВТОМАТИЧЕСКИ ОБНОВЛЯЕТСЯ                                  
?  ??????????????????????????????????????????????????????????????  
?  DataGrid получает событие PropertyChanged                       
?  Автоматически перерисовывает таблицу                            
?  Пользователь видит обновленные данные                           
????????????????????????????????????????????????????????????????????
```

---

## Граф зависимостей (Dependency Injection)

```
                    ???????????????????????
                    ?   MainViewModel     ?
                    ?  (Presentation)     ?
                    ???????????????????????
                             ?
                             ? требует
                             ?
                    ???????????????????????
                    ?   ILogic            ?
                    ?   (Interface)       ?
                    ???????????????????????
                             ?
                             ? реализация
                             ?
                    ???????????????????????
                    ?   ProductLogic      ?
                    ?   (Business Logic)  ?
                    ???????????????????????
                             ?
                   ?????????????????????
                   ?                   ?
                   ?                   ?
    ????????????????????????  ????????????????????????
    ?  IRepository         ?  ?  IBusinessFunctions  ?
    ?  (Interface)         ?  ?  (Interface)         ?
    ????????????????????????  ????????????????????????
             ?                          ?
             ? реализация               ? реализация
             ?                          ?
    ????????????????????????  ????????????????????????
    ?  EntityRepository    ?  ?  BusinessFunctions   ?
    ?  (Data Access)       ?  ?  (Calculations)      ?
    ????????????????????????  ????????????????????????
             ?
             ? использует
             ?
    ????????????????????????
    ?  AppDbContext        ?
    ?  (Entity Framework)  ?
    ????????????????????????
             ?
             ? подключение
             ?
    ????????????????????????
    ?  SQL Database        ?
    ?  (Products Table)    ?
    ????????????????????????
```

**DI Container (Ninject) автоматически разрешает все зависимости:**
```csharp
kernel.Bind<IRepository<Product>>().To<EntityRepository<Product>>();
kernel.Bind<IBusinessFunctions>().To<BusinessFunctions>();
kernel.Bind<ILogic>().To<ProductLogic>();
kernel.Bind<MainViewModel>().ToSelf();
```

---

## Структура проекта

```
ProductManagementSystem.WpfApp/
?
??? App.xaml                          # Определение приложения
??? App.xaml.cs                       # Composition Root (ViewModelFirst)
?
??? Views/
?   ??? BaseView.cs                   # Базовый класс для всех окон
?   ??? MainWindow.xaml               # UI разметка (Binding)
?   ??? MainWindow.xaml.cs            # Минимальный CodeBehind
?
??? ViewModels/
?   ??? ViewModelBase.cs              # Базовый класс ViewModel
?   ??? MainViewModel.cs              # ViewModel главного окна
?
??? Commands/
?   ??? RelayCommand.cs               # Реализация ICommand
?
??? Services/
?   ??? ViewManager.cs                # Управление окнами
?
??? Converters/
?   ??? RubleCurrencyConverter.cs     # Конвертер валюты
?
??? Documentation/
    ??? MVVM_ViewModelFirst_Documentation.md
    ??? ЗАЩИТА_MVVM.md
    ??? ШПАРГАЛКА.md
```

---

## SOLID принципы в архитектуре

```
???????????????????????????????????????????????????????????????
?  S - Single Responsibility Principle                        ?
?  ??????????????????????????????????????????????????????????  ?
?  ? BaseView       ? Только базовая функциональность окон   ?
?  ? ViewManager    ? Только создание окон                   ?
?  ? MainViewModel  ? Только логика представления            ?
?  ? ProductLogic   ? Только бизнес-логика                   ?
???????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????
?  O - Open-Closed Principle                                  ?
?  ??????????????????????????????????????????????????????????  ?
?  ? BaseView       ? Открыт для расширения (наследование)   ?
?  ? MainWindow     ? Наследует BaseView                     ?
?  ? ViewModelBase  ? Открыт для расширения                  ?
???????????????????????????????????????????????????????????????

???????????????????????????????????????????????????????????????
?  D - Dependency Inversion Principle                         ?
?  ??????????????????????????????????????????????????????????  ?
?  ? ViewManager    ? Зависит от ViewModelBase (абстракция)  ?
?  ? MainViewModel  ? Зависит от ILogic (интерфейс)          ?
?  ? ProductLogic   ? Зависит от IRepository (интерфейс)     ?
?  ? DI Container   ? Ninject управляет зависимостями        ?
???????????????????????????????????????????????????????????????
```

---

**Эта диаграмма визуализирует полную архитектуру MVVM с ViewModelFirst подходом.**
