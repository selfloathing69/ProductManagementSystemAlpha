# Реализация паттерна MVVM с подходом ViewModelFirst

## Что реализовано

### 1. Базовый класс View (`BaseView.cs`)
**Расположение:** `ProductManagementSystem.WpfApp/Views/BaseView.cs`

**Назначение:**
- Базовый класс для всех окон WPF приложения
- Реализует общую функциональность работы с ViewModel
- Обеспечивает корректное управление жизненным циклом окна

**Ключевые особенности:**
```csharp
public abstract class BaseView : Window
{
    // Доступ к ViewModel из наследников
    protected ViewModelBase? ViewModel => DataContext as ViewModelBase;
    
    // Конструктор для ViewModelFirst подхода
    protected BaseView(ViewModelBase viewModel)
    {
        DataContext = viewModel;
    }
    
    // Управление жизненным циклом
    protected virtual void OnViewLoaded(object sender, RoutedEventArgs e)
    protected virtual void OnViewUnloaded(object sender, RoutedEventArgs e)
}
```

**SOLID принципы:**
- **S (Single Responsibility):** Отвечает только за базовую функциональность окон
- **O (Open-Closed):** Открыт для расширения через наследование

---

### 2. ViewManager (`ViewManager.cs`)
**Расположение:** `ProductManagementSystem.WpfApp/Services/ViewManager.cs`

**Назначение:**
- Управление созданием и отображением окон
- Реализация паттерна ViewModelFirst
- Централизованная логика работы с окнами

**Алгоритм работы ViewModelFirst:**
```csharp
public void ShowMainWindow(MainViewModel viewModel)
{
    // 1. ViewModel уже создана (передана в параметре)
    // 2. Создаем View и передаем ViewModel в конструктор
    var mainWindow = new MainWindow(viewModel);
    
    // 3. View автоматически устанавливает DataContext
    // 4. Показываем окно пользователю
    mainWindow.Show();
}
```

**Преимущества ViewModelFirst:**
- ViewModel не зависит от View (можно тестировать отдельно)
- Упрощенное тестирование бизнес-логики
- Централизованное управление окнами
- Возможность смены View без изменения ViewModel

**SOLID принципы:**
- **S (Single Responsibility):** Отвечает только за создание окон
- **D (Dependency Inversion):** Зависит от абстракции `ViewModelBase`

---

### 3. Composition Root (`App.xaml.cs`)
**Расположение:** `ProductManagementSystem.WpfApp/App.xaml.cs`

**Назначение:**
- Точка входа приложения
- Настройка Dependency Injection
- Реализация ViewModelFirst при запуске

**Алгоритм запуска (ViewModelFirst):**
```csharp
protected override void OnStartup(StartupEventArgs e)
{
    // ШАГ 1: Настройка DI контейнера
    ConfigureDependencyInjection();
    
    // ШАГ 2: Создание ViewManager
    var viewManager = new ViewManager();
    
    // ШАГ 3: Создание MainViewModel через DI (ViewModelFirst!)
    // ВАЖНО: ViewModel создается РАНЬШЕ View!
    var mainViewModel = _kernel!.Get<MainViewModel>();
    
    // ШАГ 4: ViewManager создает и показывает окно
    // - Создает MainWindow
    // - Устанавливает DataContext = mainViewModel
    // - Показывает окно
    viewManager.ShowMainWindow(mainViewModel);
}
```

**Граф зависимостей:**
```
MainViewModel
  ? требует ILogic
ProductLogic
  ? требует IRepository<Product> + IBusinessFunctions
EntityRepository<Product> + BusinessFunctions
```

**SOLID принципы:**
- **S (Single Responsibility):** Отвечает только за инициализацию
- **D (Dependency Inversion):** Использует DI контейнер (Ninject)

---

### 4. MainWindow (`MainWindow.xaml` + `MainWindow.xaml.cs`)

**CodeBehind (`MainWindow.xaml.cs`):**
```csharp
public partial class MainWindow : BaseView
{
    // Конструктор по умолчанию (для дизайнера XAML)
    public MainWindow()
    {
        InitializeComponent();
    }
    
    // Конструктор ViewModelFirst (используется ViewManager)
    public MainWindow(MainViewModel viewModel) : base(viewModel)
    {
        InitializeComponent();
    }
}
```

**XAML (`MainWindow.xaml`):**
```xaml
<local:BaseView x:Class="ProductManagementSystem.WpfApp.Views.MainWindow"
        xmlns:local="clr-namespace:ProductManagementSystem.WpfApp.Views"
        ...>
    <!-- Все Binding работают через DataContext = MainViewModel -->
    <DataGrid ItemsSource="{Binding Products}" />
    <Button Command="{Binding RefreshCommand}" />
</local:BaseView>
```

**Ключевая особенность:** CodeBehind минимален - только `InitializeComponent()`

---

## Соответствие заданию

### ? Пункт 1: Новый проект View – WPF
- Проект `ProductManagementSystem.WpfApp` создан
- CodeBehind минимален (только `InitializeComponent()` и конструкторы)

### ? Пункт 2: ViewManager и базовый класс View
- `BaseView.cs` - базовый класс для всех окон
- `ViewManager.cs` - управление окнами

### ? Пункт 3: ViewModel и ViewManager в слое Presenter
- `ViewModelBase.cs` - базовый класс ViewModel
- `MainViewModel.cs` - наследник для главного окна
- `ViewManager.cs` - работает с View и бизнес-логикой

### ? Пункт 4: Слои DAL, Model, BusinessLogic не тронуты
- Изменения только в WPF проекте
- Бизнес-логика осталась без изменений

### ? Пункт 5: INotifyPropertyChanged в DTO
- `ProductDto` реализует `INotifyPropertyChanged`
- ViewModel работает с `ObservableCollection<ProductDto>`

### ? Пункт 6: Синхронизация с моделью
- ViewModel вызывает `ILogic` для работы с Model
- Преобразование `Product ? ProductDto` через маппинг

### ? Пункт 7: ViewModelFirst реализован
- ViewModel создается через DI контейнер
- ViewManager создает View и связывает с ViewModel
- DataContext устанавливается автоматически

---

## Поток данных в приложении

```
????????????????????????????????????????????????????????????????
? 1. ЗАПУСК ПРИЛОЖЕНИЯ (App.OnStartup)                        ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? 2. НАСТРОЙКА DI (ConfigureDependencyInjection)              ?
?    - Repository ? EntityRepository                           ?
?    - ILogic ? ProductLogic                                   ?
?    - ViewModel ? MainViewModel                               ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? 3. СОЗДАНИЕ VIEWMANAGER                                      ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? 4. СОЗДАНИЕ VIEWMODEL (ViewModelFirst!)                     ?
?    mainViewModel = _kernel.Get<MainViewModel>()              ?
?    - Ninject внедряет ILogic                                 ?
?    - ViewModel загружает данные                              ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? 5. VIEWMANAGER СОЗДАЕТ VIEW                                  ?
?    viewManager.ShowMainWindow(mainViewModel)                 ?
?    - Создает MainWindow                                      ?
?    - Устанавливает DataContext = mainViewModel               ?
?    - Показывает окно                                         ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? 6. VIEW ОТОБРАЖАЕТСЯ ПОЛЬЗОВАТЕЛЮ                           ?
?    - Все Binding работают автоматически                      ?
?    - Команды привязаны к кнопкам                             ?
?    - Данные отображаются в DataGrid                          ?
????????????????????????????????????????????????????????????????
```

---

## Взаимодействие с пользователем

```
????????????????????????????????????????????????????????????????
? ПОЛЬЗОВАТЕЛЬ НАЖИМАЕТ КНОПКУ "Обновить"                     ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? VIEW (XAML Binding)                                          ?
? <Button Command="{Binding RefreshCommand}" />                ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? VIEWMODEL (MainViewModel)                                    ?
? RefreshCommand.Execute() ? LoadProducts()                    ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? BUSINESS LOGIC (ILogic)                                      ?
? _logic.GetAllProducts() ? Repository.GetAll()                ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? DATABASE (Entity Framework)                                  ?
? SELECT * FROM Products                                       ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? МАППИНГ (Product ? ProductDto)                               ?
? ToDto(product) ? ProductDto с INotifyPropertyChanged         ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? VIEWMODEL ОБНОВЛЯЕТ КОЛЛЕКЦИЮ                                ?
? Products.Add(dto)                                            ?
? OnPropertyChanged("Products")                                ?
????????????????????????????????????????????????????????????????
                              ?
????????????????????????????????????????????????????????????????
? VIEW АВТОМАТИЧЕСКИ ОБНОВЛЯЕТСЯ                               ?
? DataGrid показывает новые данные                             ?
????????????????????????????????????????????????????????????????
```

---

## Ключевые преимущества реализации

### 1. Разделение ответственности (SOLID-S)
- **View:** Только отображение (XAML + минимальный CodeBehind)
- **ViewModel:** Логика представления и команды
- **Model:** Бизнес-логика и данные

### 2. Тестируемость
- ViewModel можно тестировать без UI
- Бизнес-логика независима от View
- Легко подменить репозиторий для тестов

### 3. Независимость компонентов (SOLID-D)
- View не знает о Model
- ViewModel не знает о конкретной View
- Все зависимости через интерфейсы

### 4. Расширяемость (SOLID-O)
- Легко добавить новые окна
- Можно создать разные View для одной ViewModel
- Бизнес-логика остается неизменной

### 5. Реактивность
- Автоматическое обновление UI через Binding
- INotifyPropertyChanged обеспечивает синхронизацию
- ObservableCollection отслеживает изменения коллекций

---

## Отличия от MVP (WinForms)

| Аспект | MVP (WinForms) | MVVM (WPF) |
|--------|----------------|------------|
| **Связь View-Presenter/ViewModel** | Через события (Event) | Через Binding и Commands |
| **CodeBehind** | Обработчики событий | Минимален (InitializeComponent) |
| **Dependency** | View знает о Presenter | View не знает о ViewModel |
| **Тестируемость** | Сложнее (View создает Presenter) | Проще (ViewModel независима) |
| **Реактивность** | Ручное обновление | Автоматическое через Binding |
| **DTO** | Простые POCO | С INotifyPropertyChanged |

---

## Итоги реализации

? **ViewModelFirst подход полностью реализован:**
- ViewModel создается ДО View
- ViewManager управляет созданием окон
- DataContext устанавливается автоматически

? **MVVM паттерн соблюден:**
- View - только XAML и минимальный CodeBehind
- ViewModel - логика представления и команды
- Model - бизнес-логика (не тронута)

? **SOLID принципы применены:**
- Single Responsibility - каждый класс одна задача
- Open-Closed - расширение через наследование
- Dependency Inversion - DI контейнер (Ninject)

? **Современный WPF UI:**
- Стилизованные элементы управления
- Адаптивная разметка
- Привязка данных через Binding

---

**Результат:** Полностью функциональное MVVM приложение с ViewModelFirst подходом, соответствующее всем требованиям лабораторной работы №5.
